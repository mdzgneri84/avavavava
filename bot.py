import os
import json
import asyncio
import aiohttp
import logging
from datetime import datetime

# Configuration
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', '')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID', '')
STEAM_API_KEY = os.environ.get('STEAM_API_KEY', '')

# Steam account IDs to monitor (just the IDs, no names needed)
STEAM_ACCOUNTS = [
    
'76561198005737632','76561198006748816','76561198006942833','76561198009972733','76561198010625337','76561198011188437',
'76561198011507370','76561198011764632','76561198012000667','76561198012181522','76561198014639808','76561199176065950',
'76561199180284068','76561199182986556','76561199192557547','76561199277499283','76561199373389203','76561199487745240',
'76561199487906778','76561199487976369','76561199488106889','76561199488616610','76561199488843297','76561199488855680',
'76561199488926170','76561199488963692','76561199489120301','76561199489459972','76561199489467320','76561199489575644',
'76561199489765233','76561199489843444','76561199489864936','76561199489922840','76561199495635521','76561199495835405',
'76561199496087758','76561199496315870','76561199496333180','76561199496555733','76561199496629890','76561199496639731',
'76561199496660782','76561199496881408','76561199496905945','76561199497001587','76561199497121095','76561199497135449',
'76561199572911787','76561199573092304','76561199573206957','76561199573213824','76561199573227265','76561199573234703',
'76561199573294612','76561199573347957','76561199573367047','76561199573378684','76561199573399730','76561199573432211',
'76561199573440052','76561199573441808','76561199573448459','76561199573473736','76561199573504620','76561199573505995',
'76561199573515673','76561199573566423','76561199573569054','76561199573624516','76561199573651659','76561199573656318',
'76561199573721428','76561199573734788','76561199573751034','76561199573772806','76561199573790149','76561199573802128',
'76561199573830863','76561199573842292','76561199573875522','76561199573942169','76561199573971867','76561199573986542',
'76561199573994571','76561199574157532','76561199574169839','76561199835585176','76561199826482317','76561199826508062',
'76561199826845736','76561199826902643','76561199827136625','76561199827171098','76561199827229050','76561199827490021',
'76561199827501538','76561199827521441','76561199827733186','76561199827733247','76561199828031518','76561199828056576',
'76561199836167617','76561199836199916','76561199836247806','76561199836326724','76561199836369890','76561199836463893',
'76561199836515436','76561199836923555','76561199837082486','76561199837549498','76561198004735803','76561198004817718',
'76561198005431705','76561198008590644','76561198011039575','76561198011360419','76561198013310225','76561198014361836',
'76561198016000277','76561198018284220','76561198033048553','76561199038044620','76561199106577061','76561199181458603',
'76561199213283513','76561199269595074','76561199271814498','76561199310382195','76561199343768581','76561199486708156',
'76561199486755601','76561199487098175','76561199487125232','76561199487431165','76561199487510751','76561199487636490',
'76561199487650377','76561199487910081','76561199488075492','76561199488183214','76561199488810816','76561199489126661',
'76561199495681364','76561199495776081','76561199495829742','76561199496069744','76561199496227456','76561199496330232',
'76561199496402393','76561199496442023','76561199496458456','76561199496671591','76561199496738518','76561199496745885',
'76561199496955989','76561199496960273','76561199496971940','76561199572957833','76561199573210567','76561199573214724',
'76561199573226985','76561199573312098','76561199573353380','76561199573375703','76561199573383502','76561199573410097',
'76561199573420385','76561199573449063','76561199573458882','76561199573465456','76561199573472161','76561199573582811',
'76561199573592419','76561199573601964','76561199573661388','76561199573695427','76561199573718102','76561199573726730',
'76561199573734358','76561199573768485','76561199573772808','76561199573790823','76561199573859348','76561199573895952',
'76561199573927234','76561199573933203','76561199573952614','76561199573959249','76561199573971888','76561199573999923',
'76561199574002078','76561199574005694','76561199574048928','76561199574105671','76561199574209870','76561199574226061',
'76561199826676624','76561199826718969','76561199826989454','76561199827155384','76561199827219812','76561199827222398',
'76561199835290638','76561199835368627','76561199835688432','76561199835793403','76561199836089272','76561199836477677',
'76561199836538185','76561199836978155','76561199836993540','76561198005477449','76561198005901886','76561198007766613',
'76561198009794696','76561198010012763','76561198011645330','76561198011918497','76561198014145241','76561198015950646',
'76561198016884594','76561199186445733','76561199187931131','76561199191527226','76561199191570541','76561199353519026',
'76561199487147688','76561199487344108','76561199487361671','76561199487491807','76561199487708392','76561199488055800',
'76561199488248265','76561199488379473','76561199488595905','76561199488737022','76561199489024221','76561199489293318',
'76561199489567728','76561199489720032','76561199489774630','76561199489931345','76561199489964129','76561199495397299',
'76561199495798645','76561199827523979','76561199827541154','76561199827682311','76561199827730826','76561199827740909',
'76561199827754992','76561199827773076','76561199827944552','76561199495907859','76561199496113274','76561199496224781',
'76561199496228525','76561199496229894','76561199496252405','76561199496451287','76561199496586048','76561199496651111',
'76561199496694203','76561199497077390','76561199497105751','76561199497128036','76561199497347588','76561199572728933',
'76561199572815564','76561199572880472','76561199573039589','76561199573166576','76561199573174566','76561199573245087',
'76561199573296663','76561199573296703','76561199573301571','76561199573514960','76561199573533872','76561199573544395',
'76561199573574226','76561199573586559','76561199573636832','76561199573645535','76561199573646599','76561199573660695',
'76561199573662867','76561199573678082','76561199573747993','76561199573763226','76561199573773381','76561199573784916',
'76561199573801710','76561199573816581','76561199573820950','76561199573835820','76561199573875054','76561199573902350',
'76561199573952269','76561199573975672','76561199573992628','76561199574029212','76561199574095391','76561199574096693',
'76561199574108969','76561199574189158','76561199835593583','76561199835797669','76561199835875056','76561199835943665',
'76561199835981349','76561199836170346','76561199836235727','76561199836484599','76561199836623819','76561199836950446',
'76561197989423966','76561198005256071','76561198005772068','76561198006226257','76561198007158768','76561198007849352',
'76561198009702577','76561198011775752','76561198012865705','76561198014394093','76561198014889865','76561198016403676',
'76561198026898348','76561199003915121','76561199156994378','76561199186155126','76561199341633432','76561199486793115',
'76561199487171365','76561199487188609','76561199487756908','76561199487872846','76561199488050795','76561199488070571',
'76561199488135882','76561199488280244','76561199826755743','76561199826781332','76561199826794230','76561199826873525',
'76561199826897832','76561199826968777','76561199827049783','76561199827074268','76561199827123478','76561199827420649',
'76561199827561025','76561199827682852','76561199827748980','76561199488280244','76561199488322947','76561199488674814',
'76561199488687047','76561199489140134','76561199489181015','76561199489220407','76561199489646099','76561199489726770',
'76561199495272554','76561199495513817','76561199495617674','76561199496001019','76561199496001827','76561199496136235',
'76561199496281116','76561199496434423','76561199496474132','76561199496669131','76561199496695874','76561199496748871',
'76561199496824401','76561199496933444','76561199572962362','76561199572975372','76561199573179223','76561199573260798',
'76561199573365299','76561199573376539','76561199573385243','76561199573427854','76561199573492095','76561199573568569',
'76561199573594090','76561199573599282','76561199573601304','76561199573628497','76561199573644228','76561199573667770',
'76561199573706659','76561199573709546','76561199573739937','76561199573754797','76561199573795667','76561199573828407',
'76561199573829117','76561199573832890','76561199573839419','76561199573850139','76561199573851844','76561199573869020',
'76561199573893228','76561199573900135','76561199573907774','76561199573946129','76561199573981560','76561199573991605',
'76561199574003705','76561199574039370','76561199574082930','76561199574165432','76561199574188093','76561199574250770',
'76561199574509115','76561199574638352','76561199835971919','76561199836027616','76561199836103584','76561199836121084',
'76561199836219126','76561199836319696','76561199836401020','76561199836577063','76561199836691938','76561199836905182',
'76561199093833328','76561199145300821','76561199184920278','76561199188869387','76561199191145332','76561199195626554',
'76561199486533160','76561199486756701','76561199487642121','76561199487979379','76561199488060553','76561199488181277',
'76561199488219789','76561199826019590','76561199826706972','76561199826721124','76561199826975887','76561199827004106',
'76561199827126955','76561199827138206','76561199827266489','76561199827448684','76561199827449323','76561199827627928',
'76561199827921037','76561199828160205','76561199828162104','76561199488238783','76561199488351517','76561199488500811',
'76561199489372971','76561199489603198','76561199489618005','76561199489663568','76561199489871066','76561199496116257',
'76561199496228471','76561199496416970','76561199496417779','76561199496497346','76561199496523352','76561199496574514',
'76561199496616686','76561199496664324','76561199496723661','76561199496743916','76561199496810378','76561199496948850',
'76561199497018923','76561199497237243','76561199573021274','76561199573143515','76561199573219973','76561199573234455',
'76561199573344687','76561199573347029','76561199573380811','76561199573382024','76561199573507092','76561199573507171',
'76561199573531732','76561199573547682','76561199573554537','76561199573563750','76561199573565761','76561199573585139',
'76561199573590375','76561199573598400','76561199573610785','76561199573684911','76561199573700670','76561199573717929',
'76561199573765733','76561199573783967','76561199573802638','76561199573808490','76561199573811992','76561199573821593',
'76561199573845987','76561199573849551','76561199573868906','76561199573925631','76561199573942538','76561199574046319',
'76561199574128763','76561199574187111','76561199574202926','76561199574461274','76561199835787156','76561199835849827',
'76561199835927937','76561199835997278','76561199836009253','76561199836249311','76561199836334875','76561199836456265',
'76561199836705574','76561199837274524','76561197992383333','76561198004784546','76561198005496993','76561198009844065',
'76561198009906360','76561198010360916','76561198011979027','76561198012764220','76561198014038692','76561198017077861',
'76561198017158006','76561198017644191','76561198037430564','76561198993755095','76561199144439232','76561199266026870',
'76561199355955937','76561199826937906','76561199827032703','76561199827090197','76561199827146277','76561199827233445',
'76561199827353060','76561199827368026','76561199827606574','76561199827657087','76561199827690766','76561199827911926',
'76561199828090034','76561199828163397','76561199828305137','76561199380332744','76561199486872940','76561199486991319',
'76561199487314882','76561199487612972','76561199487686992','76561199487857799','76561199488012632','76561199488078467',
'76561199488128914','76561199488260620','76561199488496947','76561199488518544','76561199488627032','76561199488865230',
'76561199489088333','76561199489203629','76561199495370914','76561199495787230','76561199496026508','76561199496074573',
'76561199496238556','76561199496365187','76561199496389553','76561199496504070','76561199496694534','76561199496714603',
'76561199496998599','76561199497103943','76561199497174531','76561199497330208','76561199572930037','76561199573094006',
'76561199573187124','76561199573298087','76561199573340943','76561199573352203','76561199573365283','76561199573367564',
'76561199573375376','76561199573416584','76561199573449635','76561199573476621','76561199573482721','76561199573483831',
'76561199573532651','76561199573545056','76561199573551468','76561199573566227','76561199573579600','76561199573592850',
'76561199573626704','76561199573629987','76561199573666958','76561199573680536','76561199573714328','76561199573732694',
'76561199573792519','76561199573794440','76561199573862496','76561199573896225','76561199573909766','76561199573937302',
'76561199573953205','76561199573979213','76561199573981845','76561199574133104','76561199574137298','76561199574199421',
'76561199574333530','76561199574409923','76561199835779907','76561199836064571','76561199836215463','76561199836237875',
'76561199836238073','76561199836250812','76561199836353839','76561199836492106','76561199836643886','76561199836941150',
'76561199000314874','76561199186067398','76561199194980827','76561199213412085','76561199333464259','76561199486358469',
'76561199486937123','76561199826506769','76561199826688994','76561199826750631','76561199826774453','76561199827008836',
'76561199827184137','76561199827209165','76561199827399649','76561199827539908','76561199827810205','76561199827860898',
'76561199827873340','76561199827947051','76561199827968677','76561199486973269','76561199487203978','76561199487369299',
'76561199487970760','76561199488180248','76561199488735809','76561199488861465','76561199489193457','76561199489264846',
'76561199489421703','76561199489422738','76561199489532111','76561199489693282','76561199489846035','76561199490240223',
'76561199495816117','76561199495947004','76561199495994444','76561199496028249','76561199496062176','76561199496063219',
'76561199496154786','76561199496439723','76561199496458182','76561199496502806','76561199496794618','76561199496821087',
'76561199496825469','76561199496995339','76561199572695461','76561199572711408','76561199572867775','76561199573066754',
'76561199573107709','76561199573107878','76561199573127295','76561199573183917','76561199573244454','76561199573256389',
'76561199573257298','76561199573331720','76561199573374139','76561199573389111','76561199573402162','76561199573402374',
'76561199573414493','76561199573461488','76561199573472883','76561199573509360','76561199573553716','76561199573582701',
'76561199573584523','76561199573589041','76561199573650799','76561199573650929','76561199573663680','76561199573664542',
'76561199573727161','76561199573731640','76561199573763840','76561199573812460','76561199573822530','76561199573835655',
'76561199573995864','76561199574007932','76561199574112260','76561199574258921','76561199574342938','76561199574411279',
'76561199574784892','76561199835807915','76561199836109862','76561199836251217','76561199836252414','76561199836425103',
'76561199836511070','76561199836532348','76561199836532956','76561199836751465','76561199836973714','76561198366127408',
'76561198005587518','76561198007421735','76561199826509355','76561199826522888','76561199826728621','76561199827127386',
'76561199827341154','76561199827417590','76561199827730586','76561199827731893','76561199827732981','76561199827920606',
'76561199827968499','76561198123008839','76561198049812132','76561198007920119','76561198009862925','76561198009958314',
'76561198011064397','76561198011402939','76561198013881188','76561198014221038','76561198014273675','76561198012786360',
'76561198013354511','76561198014226001','76561198015562736','76561198016363245','76561199124726174','76561199182269277',
'76561199183841340','76561199189581018','76561199337956551','76561199368674766','76561199380890506','76561199486600439',
'76561199487051476','76561199487227797','76561199487395372','76561199487440925','76561199487764349','76561199488436689',
'76561199488514872','76561199488619718','76561199488824878','76561199489168763','76561199489794119','76561199490023145',
'76561199490116658','76561199490464802','76561197970787214','76561198189354514','76561198281687363','76561199495821259',
'76561199495880353','76561199495975116','76561199496260756','76561199496325872','76561199496330048','76561199496341875',
'76561199496342547','76561199496429133','76561199496680344','76561199496779340','76561199496788190','76561199496907701',
'76561199496989854','76561199497582774','76561199572721936','76561199573038111','76561199573040238','76561199573112130',
'76561199573169083','76561199573234981','76561199573266489','76561199573352744','76561199573417068','76561199573478396',
'76561199573520937','76561199573523768','76561199573524198','76561199573539520','76561199573564239','76561199573573983',
'76561199573579610','76561199573583824','76561199573585387','76561199573634476','76561199573648822','76561199573677014',
'76561199573718514','76561199573762885','76561199573777924','76561199573778786','76561199573797538','76561199573815465',
'76561199573845767','76561199573848980','76561199573958376','76561199573974753','76561199574003192','76561199574175997',
'76561199574190989','76561199574224569','76561199495637145','76561199495643844','76561199496004092','76561199496015434',
'76561199496268110','76561199496273250','76561199496338141','76561199496357908','76561199496510564','76561199496529390',
'76561199496563148','76561199496846851','76561199496985952','76561199497013099','76561199497092725','76561199497135931',
'76561199572747365','76561199572809590','76561199572812950','76561199572828554','76561199573070209','76561199573170315',
'76561199573264033','76561199573276142','76561199573278134','76561199573289326','76561199573302407','76561199573309378',
'76561199573331752','76561199573359907','76561199573362507','76561199573398379','76561199573472176','76561199573484128',
'76561199573520655','76561199573553486','76561199573688603','76561199573720655','76561199573753216','76561199573763991',
'76561199573773797','76561199573800848','76561199573821089','76561199573829902','76561199573834618','76561199573888034',
'76561199573950619','76561199573967070','76561199574024232','76561199574052782','76561199574116272','76561199574144461',
'76561199574163628','76561199574287112','76561199574401521','76561199835602536','76561199835714035','76561199835788236',
'76561199835795597','76561199835928149','76561199836130005','76561199836226899','76561199836370919','76561199836770018',
'76561199837089473','76561198004994636','76561198005764608','76561198007667299','76561198007864301','76561198008244438',
'76561198014325326','76561198017047244','76561198017898437','76561198987515581','76561198993281452','76561199040623779',
'76561199181290571','76561199185686175','76561199189432278','76561199306770051','76561199487005719','76561199487327979',
'76561199487497538','76561199487920526','76561199487955621','76561199488172342','76561199488199331','76561199826142710',
'76561199827066178','76561199827190789','76561199827252077','76561199827493906','76561199827511735','76561199827540220',
'76561199827649945','76561199827769501','76561199827926064','76561199827998732','76561199828022917','76561199828500424',
'76561199026826246','76561199488199331','76561199488539400','76561199488877743','76561199489021514','76561199489060963',
'76561199489460772','76561199489611162','76561199489745505','76561199495078579','76561199495527988','76561199496112771',
'76561199496118421','76561199496211919','76561199496216944','76561199496254369','76561199496430534','76561199496444525',
'76561199496508051','76561199496610665','76561199496769541','76561199496846289','76561199497015619','76561199497124322',
'76561199573015479','76561199573107385','76561199573134835','76561199573191926','76561199573232660','76561199573247369',
'76561199573305477','76561199573335544','76561199573418717','76561199573465827','76561199573469166','76561199573475778',
'76561199573514037','76561199573514884','76561199573576976','76561199573614045','76561199573635241','76561199573712128',
'76561199573720242','76561199573742115','76561199573774228','76561199573789349','76561199573801223','76561199573837379',
'76561199573838752','76561199573839894','76561199573848485','76561199573896785','76561199573908950','76561199573924483',
'76561199573933918','76561199573934231','76561199573964723','76561199573986410','76561199574067723','76561199574071188',
'76561199574111760','76561199574145928','76561199574193916','76561199574384089','76561199835618252','76561199835762125',
'76561199835985512','76561199836261760','76561199836271024','76561199836584366','76561199836604366','76561199836616157',
'76561199836844944','76561199837446074','76561198149469646','76561198004943213','76561198006443045','76561198007845771',
'76561198008578973','76561198009152296','76561198013870435','76561198014920098','76561199826493472','76561199826676193',
'76561199826995034','76561199827098598','76561199827195969','76561199827258915','76561198058118000','76561198045288245',
'76561198798019564','76561198981438100','76561198060806749','76561199514390756','76561199655324168','76561199747892947',
'76561198376829135','76561198386926570','76561199351824048','76561198033249843','76561198034432157','76561199485873417',
'76561198793825714','76561198155811728','76561198180491178','76561198249942374','76561198144357621','76561198131642648',
'76561199443802924','76561199544258926','76561198392494864','76561198199228331','76561199223759358','76561198839728826',
'76561198352974783','76561198352974783','76561198835518367','76561199035683390','76561198843600814','76561198962749786',
'76561199727957401','76561199592437801','76561199570743351','76561199192150257','76561199046077677','76561199569744536',
'76561199099416488','76561198882110310','76561198833815364','76561199035524504','76561199100757829','76561197999044092',
'76561199035524504','76561199210455209','76561199213203805','76561199046077677','76561199192150257','76561199105008648',
'76561199067051379','76561199248513528','76561199509911358','76561199526266956','76561199786857714','76561199773790707',
'76561198795150315','76561198000122075','76561198001149686','76561197999365947','76561199545422896','76561199523079624',
'76561199239448125','76561199472990101','76561199364229305','76561199386981826','76561199453781060','76561199545965428',
'76561199507420508','76561199507410413','76561199364236014','76561199511695528','76561199227089062','76561199221133544',
'76561199446661794','76561199507169363','76561199510851138','76561199509887225','76561199093646362','76561199140992806',
'76561199076999508','76561199239570712','76561199133669185','76561198079869692','76561199545399041','76561199702162559',
'76561199310037380','76561199510458228','76561199484376530','76561199319905419','76561199228669966','76561199507103817',
'76561199467323390','76561199507711258','76561199680773490','76561199737363693','76561199712962309','76561199798892735',
'76561199566800840','76561199701744524','76561199797310424','76561199566903184','76561199605136008','76561199667701900',
'76561199689996718','76561199614455891','76561199781179736','76561199675184915','76561199241416845','76561199744755858',
'76561199729698848','76561199642659944','76561199513189061','76561198981485810','76561198853234202','76561198352650472',
'76561199680773490','76561199798892735','76561199614455891','76561199696415751','76561199801089217','76561199767058596',
'76561199240063525','76561199688802916','76561199404414716','76561199765839486','76561199563875260','76561198980863448',
'76561199696284428','76561199742212953','76561199693484195','76561199507281783','76561199511613148','76561198867351549',
'76561199167281779','76561199101414271','76561199567531804','76561199696284428','76561199742212953','76561199681941103',
'76561199596481907','76561199767134016','76561198041694479','76561199233254553','76561199167281779','76561199174415554',
'76561199360962076','76561199596108964','76561199822123816','76561198972731476','76561199562965213','76561199680012174',
'76561198089686722','76561199566212225','76561199801044428','76561199615337959','76561198091803782','76561198315785773',
'76561199562282664','76561199140187953','76561198001045849','76561198005378239','76561198000221307','76561197997501541',
'76561197999044092','76561197999365947','76561197997346810','76561198005763155','76561197997911605','76561198000100857',
'76561198000122075','76561198001149686','76561197998703660','76561198003439119','76561198006139255','76561198004929896',
'76561198002099385','76561197999746030','76561197997354378','76561197996827846','76561198005552822','76561197999042784',
'76561198000587182','76561197997525092','76561198006132071','76561198005763155','76561198000221307','76561198005378239',
'76561197997346810','76561197997315077','76561197997926013','76561198001045849','76561197997366660','76561197996163955',
'76561197997329269','76561197998181431','76561197999471706','76561198000253999','76561197998492586','76561197996827846',
'76561197997354378','76561198004372037','76561198001007227','76561198001504709','76561197998485237','76561197997264852',
'76561198001952761','76561198000027616','76561198000819973','76561197996966611','76561197997288237','76561198000016577',
'76561198000819973','76561197998067347','76561198002333190','76561197997252212','76561197999481849','76561197997288237',
'76561198004618317','76561197997051506','76561198000322553','76561198001452389','76561197997070799','76561197999853385',
'76561197997017005','76561197997233864','76561197999978055','76561197999510382','76561197999793289','76561198008702722',
'76561197998970053','76561198000016577','76561198001563271','76561197998970053','76561197997444231','76561199420585163',
'76561199418247201','76561199420145920','76561199418420356','76561199418723632','76561198018506005','76561199544485737',
'76561199418056704','76561199418647418','76561199420234419','76561199545367639','76561199418930658','76561199545096013',
'76561199544756210','76561199417912749','76561199420145920',



    
    
]

DATA_FILE = 'friend_data.json'
INIT_FILE = '.initialized'

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger("SteamFriendIDMonitor")

def get_profile_link(steam_id):
    """Generate Steam profile link from Steam ID"""
    return f"steamcommunity.com/profiles/{steam_id}"

async def fetch_friend_list(session, steam_id):
    """Fetch the complete friend list for a Steam account"""
    url = f"http://api.steampowered.com/ISteamUser/GetFriendList/v0001/?key={STEAM_API_KEY}&steamid={steam_id}&relationship=friend"
    profile_link = get_profile_link(steam_id)
    
    try:
        async with session.get(url, timeout=10) as resp:
            if resp.status == 200:
                data = await resp.json()
                friends_data = data.get('friendslist', {}).get('friends', [])
                # Extract just the Steam IDs of friends
                friend_ids = [friend['steamid'] for friend in friends_data]
                return steam_id, profile_link, friend_ids
            elif resp.status == 403:
                logger.warning(f"{profile_link} is private")
                return steam_id, profile_link, None
            else:
                logger.error(f"{profile_link}: API error {resp.status}")
                return steam_id, profile_link, None
    except Exception as e:
        logger.error(f"Error fetching {profile_link}: {e}")
        return steam_id, profile_link, None

async def send_telegram_message(message):
    """Send message to Telegram, splitting if too long"""
    MAX_MESSAGE_LENGTH = 4000  # Leave some buffer under 4096 limit
    
    if len(message) <= MAX_MESSAGE_LENGTH:
        await _send_single_message(message)
    else:
        # Split message into chunks
        lines = message.split('\n')
        current_chunk = ""
        
        for line in lines:
            # If adding this line would exceed limit, send current chunk
            if len(current_chunk + line + '\n') > MAX_MESSAGE_LENGTH:
                if current_chunk:
                    await _send_single_message(current_chunk.strip())
                    current_chunk = line + '\n'
                else:
                    # Single line is too long, truncate it
                    await _send_single_message(line[:MAX_MESSAGE_LENGTH])
            else:
                current_chunk += line + '\n'
        
        # Send remaining chunk
        if current_chunk:
            await _send_single_message(current_chunk.strip())

async def _send_single_message(message):
    """Send a single message to Telegram"""
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        'chat_id': TELEGRAM_CHAT_ID,
        'text': message,
        'parse_mode': 'HTML'
    }
    async with aiohttp.ClientSession() as session:
        try:
            async with session.post(url, data=payload) as resp:
                if resp.status != 200:
                    logger.error(f"Failed to send message: {await resp.text()}")
                else:
                    logger.info("Telegram message sent successfully")
        except Exception as e:
            logger.error(f"Telegram error: {e}")

def load_previous_data():
    """Load previous friend data from file"""
    try:
        with open(DATA_FILE, 'r') as f:
            return json.load(f)
    except:
        return {}

def save_data(data):
    """Save friend data to file"""
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=2)

def is_first_run():
    """Check if this is the first run of the bot"""
    if os.path.exists(INIT_FILE):
        return False
    with open(INIT_FILE, 'w') as f:
        f.write(datetime.now().isoformat())
    return True

async def check_accounts():
    """Main function to check all accounts for friend changes"""
    first_run = is_first_run()
    previous_data = load_previous_data()
    current_data = {}
    all_new_friends = []  # Collect all new friends for batched notification
    
    async with aiohttp.ClientSession() as session:
        tasks = [fetch_friend_list(session, steam_id) for steam_id in STEAM_ACCOUNTS]
        results = await asyncio.gather(*tasks)

    for steam_id, profile_link, friend_ids in results:
        if friend_ids is None:
            continue
            
        current_data[steam_id] = {
            'profile_link': profile_link,
            'friends': friend_ids,
            'count': len(friend_ids)
        }
        
        # Skip change detection on first run
        if first_run or steam_id not in previous_data:
            continue
            
        previous_friends = set(previous_data[steam_id].get('friends', []))
        current_friends = set(friend_ids)
        
        # Check for new friends only
        new_friends = current_friends - previous_friends
        if new_friends:
            for friend_id in new_friends:
                friend_profile_link = get_profile_link(friend_id)
                all_new_friends.append(friend_profile_link)
                logger.info(f"New friend detected: {friend_id} added to {steam_id}")
        
        # Log removed friends (no telegram notification)
        removed_friends = previous_friends - current_friends
        if removed_friends:
            for friend_id in removed_friends:
                logger.info(f"Friend removed: {friend_id} removed from {steam_id}")

    # Send batched notification for all new friends
    logger.info(f"Total new friends collected: {len(all_new_friends)}")
    logger.info(f"First run status: {first_run}")
    
    if all_new_friends and not first_run:
        if len(all_new_friends) == 1:
            msg = f"New friend: {all_new_friends[0]}"
        else:
            msg = f"New friends detected ({len(all_new_friends)}):\n\n"
            msg += "\n".join([f"• {friend_link}" for friend_link in all_new_friends])
        
        logger.info(f"Attempting to send Telegram message: {msg[:100]}...")
        await send_telegram_message(msg)
        logger.info(f"Sent batched notification for {len(all_new_friends)} new friends")
    elif all_new_friends and first_run:
        logger.info(f"New friends detected on first run (not sending notification): {len(all_new_friends)}")
    else:
        logger.info("No new friends detected in this cycle")

    # Save current data
    save_data(current_data)

    if first_run:
        # Log initial setup (no telegram messages)
        total_accounts = len(current_data)
        private_accounts = len(STEAM_ACCOUNTS) - total_accounts
        total_friends = sum(data['count'] for data in current_data.values())
        
        logger.info(f"Steam Friend ID Monitor Setup Complete")
        logger.info(f"Monitoring {total_accounts} accounts")
        logger.info(f"Total friends being tracked: {total_friends}")
        if private_accounts > 0:
            logger.info(f"{private_accounts} accounts are private")
        logger.info("Bot will now notify when specific friends are added with their Steam IDs")
    else:
        logger.info("Friend check completed")

if __name__ == '__main__':
    asyncio.run(check_accounts())
